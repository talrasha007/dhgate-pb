---
import Layout from '../layouts/Layout.astro';
---

<Layout>
  <div class="page">
    <header class="page-header">
      <div>
        <h1>DL SDK 请求</h1>
        <p class="muted">支持按 app_id 或 app_name 搜索应用，并按平台自动填充参数。</p>
      </div>
      <div class="platform-pill" id="platformPill">未选择应用</div>
    </header>

    <section class="card">
      <div class="field">
        <label for="appInput">应用</label>
        <input id="appInput" type="text" placeholder="输入 app_id 或 app_name" autocomplete="off" />
        <div id="suggestions" class="suggestions"></div>
        <div id="appMeta" class="muted"></div>
      </div>

      <div class="grid">
        <div class="field">
          <label for="ipInput">IP (可选)</label>
          <input id="ipInput" type="text" placeholder="1.2.3.4" />
        </div>
        <div class="field ios-only">
          <label for="idfaInput">IDFA (可选)</label>
          <input id="idfaInput" type="text" placeholder="iOS IDFA" />
        </div>
        <div class="field android-only">
          <label for="gaidInput">GAID (可选)</label>
          <input id="gaidInput" type="text" placeholder="Android GAID" />
        </div>
        <div class="field android-only">
          <label for="modelInput">机型</label>
          <input id="modelInput" type="text" placeholder="Pixel 5" />
        </div>
        <div class="field">
          <label for="versionInput">系统版本</label>
          <input id="versionInput" type="text" placeholder="iOS 26.1 / Android 13" />
        </div>
      </div>

      <div class="actions">
        <button id="sendBtn" type="button">发送请求</button>
      </div>
    </section>

    <section class="card">
      <div class="field">
        <label>响应</label>
        <pre id="output" class="output">等待请求...</pre>
      </div>
    </section>
  </div>

  <script type="module">
    const appInput = document.getElementById('appInput');
    const suggestions = document.getElementById('suggestions');
    const appMeta = document.getElementById('appMeta');
    const platformPill = document.getElementById('platformPill');
    const output = document.getElementById('output');
    const sendBtn = document.getElementById('sendBtn');

    const ipInput = document.getElementById('ipInput');
    const idfaInput = document.getElementById('idfaInput');
    const gaidInput = document.getElementById('gaidInput');
    const modelInput = document.getElementById('modelInput');
    const versionInput = document.getElementById('versionInput');

    const iosFields = document.querySelectorAll('.ios-only');
    const androidFields = document.querySelectorAll('.android-only');

    let apps = [];
    let selectedApp = null;

    const setPlatform = (appId) => {
      const isIos = appId && appId.startsWith('id');
      platformPill.textContent = appId
        ? isIos
          ? 'iOS'
          : 'Android'
        : '未选择应用';
      platformPill.classList.toggle('pill-ios', isIos);
      platformPill.classList.toggle('pill-android', appId && !isIos);

      iosFields.forEach((el) => {
        el.style.display = isIos ? 'grid' : 'none';
      });
      androidFields.forEach((el) => {
        el.style.display = appId && !isIos ? 'grid' : 'none';
      });
    };

    const updateMeta = () => {
      if (!selectedApp) {
        appMeta.textContent = '';
        return;
      }
      appMeta.textContent = `${selectedApp.app_name} · ${selectedApp.app_id}`;
    };

    const renderSuggestions = (items) => {
      suggestions.innerHTML = '';
      if (!items.length) return;
      const list = document.createElement('div');
      list.className = 'suggestions-list';
      items.forEach((app) => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'suggestion-item';
        item.innerHTML = `<strong>${app.app_name}</strong><span>${app.app_id}</span>`;
        item.addEventListener('click', () => {
          appInput.value = app.app_id;
          selectedApp = app;
          updateMeta();
          setPlatform(app.app_id);
          suggestions.innerHTML = '';
        });
        list.appendChild(item);
      });
      suggestions.appendChild(list);
    };

    const filterApps = (value) => {
      const keyword = value.trim().toLowerCase();
      if (!keyword) return [];
      return apps
        .filter((app) =>
          app.app_id.toLowerCase().includes(keyword) ||
          app.app_name.toLowerCase().includes(keyword)
        )
        .slice(0, 8);
    };

    const syncSelected = () => {
      const match = apps.find((app) => app.app_id === appInput.value.trim());
      selectedApp = match || null;
      updateMeta();
      setPlatform(match ? match.app_id : appInput.value.trim());
    };

    const fetchApps = async () => {
      try {
        const response = await fetch('/api/af/apps');
        if (!response.ok) throw new Error('加载应用失败');
        apps = await response.json();
      } catch (error) {
        appMeta.textContent = '应用列表加载失败';
      }
    };

    const applyZeroGuid = (input) => {
      if (!input) return;
      input.addEventListener('blur', () => {
        if (input.value.trim() === '00') {
          input.value = '00000000-0000-0000-0000-000000000000';
        }
      });
    };

    const sendRequest = async () => {
      const appId = appInput.value.trim();
      if (!appId) {
        output.textContent = '请先选择应用';
        return;
      }

      const isIos = appId.startsWith('id');
      const params = new URLSearchParams({ app: appId });

      if (ipInput.value.trim()) params.set('ip', ipInput.value.trim());
      if (versionInput.value.trim()) params.set('version', versionInput.value.trim());

      if (isIos) {
        if (idfaInput.value.trim()) params.set('idfa', idfaInput.value.trim());
      } else {
        if (gaidInput.value.trim()) params.set('gaid', gaidInput.value.trim());
        if (modelInput.value.trim()) params.set('model', modelInput.value.trim());
      }

      output.textContent = '请求中...';
      try {
        const response = await fetch(`/api/af/dlsdk?${params.toString()}`);
        const text = await response.text();
        let content = text;
        try {
          content = JSON.stringify(JSON.parse(text), null, 2);
        } catch (parseError) {
          content = text;
        }
        if (!response.ok) {
          output.textContent = `请求失败 (${response.status})\n${content}`;
        } else {
          output.textContent = content;
        }
      } catch (error) {
        output.textContent = '请求失败，请稍后重试';
      }
    };

    appInput.addEventListener('input', (event) => {
      const value = event.target.value;
      renderSuggestions(filterApps(value));
      syncSelected();
    });

    appInput.addEventListener('blur', () => {
      setTimeout(() => {
        suggestions.innerHTML = '';
      }, 120);
    });

    applyZeroGuid(idfaInput);
    applyZeroGuid(gaidInput);

    sendBtn.addEventListener('click', sendRequest);

    setPlatform('');
    fetchApps();
  </script>
</Layout>

<style>
  :root {
    color-scheme: light;
  }

  .page {
    max-width: 960px;
    margin: 0 auto;
    padding: 24px 16px 48px;
    display: grid;
    gap: 20px;
  }

  .page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
  }

  .muted {
    color: #6b7280;
    font-size: 14px;
  }

  .platform-pill {
    padding: 6px 12px;
    border-radius: 999px;
    background: #e5e7eb;
    font-size: 12px;
    font-weight: 600;
  }

  .pill-ios {
    background: #dbeafe;
    color: #1e40af;
  }

  .pill-android {
    background: #dcfce7;
    color: #166534;
  }

  .card {
    background: #ffffff;
    border-radius: 16px;
    border: 1px solid #e5e7eb;
    padding: 20px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
  }

  .field {
    display: grid;
    gap: 8px;
  }

  label {
    display: block;
    font-size: 13px;
    font-weight: 600;
  }

  input {
    width: 100%;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 14px;
    box-sizing: border-box;
  }

  .grid {
    display: grid;
    gap: 14px;
    margin-top: 16px;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  }

  .actions {
    margin-top: 18px;
    display: flex;
    justify-content: flex-end;
  }

  button {
    border: none;
    border-radius: 10px;
    padding: 10px 18px;
    background: #111827;
    color: #fff;
    font-weight: 600;
    cursor: pointer;
  }

  button:active {
    transform: translateY(1px);
  }

  .suggestions {
    position: relative;
  }

  .suggestions-list {
    position: absolute;
    z-index: 10;
    top: 6px;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
    padding: 6px;
    display: grid;
    gap: 6px;
  }

  .suggestion-item {
    border: none;
    background: #f9fafb;
    border-radius: 10px;
    padding: 10px 12px;
    text-align: left;
    display: grid;
    gap: 4px;
    color: #111827;
    cursor: pointer;
  }

  .suggestion-item span {
    font-size: 12px;
    color: #6b7280;
  }

  .output {
    min-height: 220px;
    background: #0f172a;
    color: #e2e8f0;
    border-radius: 12px;
    padding: 16px;
    font-size: 12px;
    overflow-x: auto;
  }

  @media (max-width: 640px) {
    .page-header {
      flex-direction: column;
      align-items: flex-start;
    }
    .actions {
      justify-content: stretch;
    }
    button {
      width: 100%;
    }
  }
</style>
